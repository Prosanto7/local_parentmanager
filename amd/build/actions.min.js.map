{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for Parent Manager plugin actions.\n *\n * @module     local_parentmanager/actions\n * @copyright  2026\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/modal', 'core/modal_save_cancel', 'core/modal_events', 'core/str'],\n    function($, Ajax, Notification, Modal, ModalSaveCancel, ModalEvents, Str) {\n\n    /**\n     * Initialize the module.\n     */\n    var init = function() {\n        // Handle \"View Children\" action.\n        $(document).on('click', '[data-action=\"view-children\"]', function(e) {\n            e.preventDefault();\n            var parentId = $(this).data('parentid');\n            var parentName = $(this).data('parentname');\n            viewChildren(parentId, parentName);\n        });\n\n        // Handle \"Assign Child\" action.\n        $(document).on('click', '[data-action=\"assign-child\"]', function(e) {\n            e.preventDefault();\n            var parentId = $(this).data('parentid');\n            var parentName = $(this).data('parentname');\n            assignChild(parentId, parentName);\n        });\n\n        // Handle \"Remove Parent\" action.\n        $(document).on('click', '[data-action=\"remove-parent\"]', function(e) {\n            e.preventDefault();\n            var parentId = $(this).data('parentid');\n            var parentName = $(this).data('parentname');\n            removeParent(parentId, parentName);\n        });\n    };\n\n    /**\n     * View children assigned to a parent.\n     *\n     * @param {int} parentId Parent user ID\n     * @param {string} parentName Parent name\n     */\n    var viewChildren = function(parentId, parentName) {\n        Str.get_strings([\n            {key: 'assignedchildrenforparent', component: 'local_parentmanager'},\n            {key: 'nochildren', component: 'local_parentmanager'},\n            {key: 'remove', component: 'core'},\n            {key: 'close', component: 'core'}\n        ]).done(function(strings) {\n            Ajax.call([{\n                methodname: 'local_parentmanager_get_children',\n                args: {parentid: parentId}\n            }])[0].done(function(response) {\n                var body = '<div class=\"parent-children-list\">';\n\n                if (response.children.length === 0) {\n                    body += '<p>' + strings[1] + '</p>';\n                } else {\n                    body += '<table class=\"table table-striped\">';\n                    body += '<thead><tr><th>Name</th><th>Email</th><th>Actions</th></tr></thead>';\n                    body += '<tbody>';\n\n                    response.children.forEach(function(child) {\n                        body += '<tr>';\n                        body += '<td><a href=\"' + child.profileurl + '\" target=\"_blank\">' + child.fullname + '</a></td>';\n                        body += '<td>' + child.email + '</td>';\n                        body += '<td><button class=\"btn btn-sm btn-danger\" data-action=\"remove-child\" ' +\n                                'data-relationid=\"' + child.relationid + '\">' + strings[2] + '</button></td>';\n                        body += '</tr>';\n                    });\n\n                    body += '</tbody></table>';\n                }\n\n                body += '</div>';\n\n                Modal.create({\n                    title: strings[0] + ': ' + parentName,\n                    body: body,\n                    show: true,\n                    removeOnClose: true,\n                    large: true,\n                }).then(function(modal) {\n                    // Handle remove child within modal.\n                    modal.getRoot().on('click', '[data-action=\"remove-child\"]', function(e) {\n                        e.preventDefault();\n                        var relationId = $(this).data('relationid');\n                        removeChild(relationId, modal);\n                    });\n                });\n            }).fail(Notification.exception);\n        });\n    };\n\n    /**\n     * Remove a child from a parent.\n     *\n     * @param {int} relationId Relation ID\n     */\n    var removeChild = function(relationId) {\n        Str.get_strings([\n            {key: 'confirm', component: 'core'},\n            {key: 'confirmremovechild', component: 'local_parentmanager'},\n            {key: 'yes', component: 'core'},\n            {key: 'no', component: 'core'},\n            {key: 'childremoved', component: 'local_parentmanager'}\n        ]).done(function(strings) {\n            Notification.confirm(strings[0], strings[1], strings[2], strings[3], function() {\n                Ajax.call([{\n                    methodname: 'local_parentmanager_remove_child',\n                    args: {relationid: relationId}\n                }])[0].done(function(response) {\n                    if (response.success) {\n                        window.location.reload();\n                    }\n                }).fail(Notification.exception);\n            });\n        });\n    };\n\n    /**\n     * Assign children to a parent.\n     *\n     * @param {int} parentId Parent user ID\n     * @param {string} parentName Parent name\n     */\n    var assignChild = function(parentId, parentName) {\n        require(['core/fragment'], function(Fragment) {\n            Str.get_strings([\n                {key: 'assignchild', component: 'local_parentmanager'},\n                {key: 'assign', component: 'local_parentmanager'},\n                {key: 'childrenassigned', component: 'local_parentmanager'}\n            ]).done(function(strings) {\n                var formPromise = Fragment.loadFragment(\n                    'local_parentmanager',\n                    'assign_form',\n                    1,\n                    {parentid: parentId}\n                );\n\n                // Create modal with the form as body.\n                ModalSaveCancel.create({\n                    title: strings[0] + ': ' + parentName,\n                    body: formPromise,\n                    show: true,\n                    removeOnClose: true,\n                    large: true,\n                }).then(function(modal) {\n                    modal.setSaveButtonText(strings[1]);\n\n                    // Handle form submission.\n                    modal.getRoot().on(ModalEvents.save, function(e) {\n                        e.preventDefault();\n\n                        // Get form data.\n                        var form = modal.getRoot().find('form');\n                        var selectedIds = form.find('[name=\"childuserids[]\"]').val();\n\n                        if (!selectedIds || selectedIds.length === 0) {\n                            Str.get_string('noselectederror', 'local_parentmanager').done(function(errorMsg) {\n                                Notification.addNotification({\n                                    message: errorMsg,\n                                    type: 'warning'\n                                });\n                            });\n                            return;\n                        }\n\n                        // Convert to integers.\n                        selectedIds = selectedIds.map(function(id) {\n                            return parseInt(id);\n                        });\n\n                        // Submit via AJAX.\n                        Ajax.call([{\n                            methodname: 'local_parentmanager_assign_children',\n                            args: {\n                                parentid: parentId,\n                                childids: selectedIds\n                            }\n                        }])[0].done(function(response) {\n                            if (response.success) {\n                                modal.hide();\n                                // Reload the page.\n                                window.location.reload();\n                            }\n                        }).fail(Notification.exception);\n                    });\n                });\n            });\n        });\n    };\n\n    /**\n     * Remove parent status.\n     *\n     * @param {int} parentId Parent user ID\n     * @param {string} parentName Parent name\n     */\n    var removeParent = function(parentId, parentName) {\n        Str.get_strings([\n            {key: 'confirm', component: 'core'},\n            {key: 'confirmremoveparent', component: 'local_parentmanager'},\n            {key: 'yes', component: 'core'},\n            {key: 'no', component: 'core'},\n            {key: 'parentremoved', component: 'local_parentmanager'}\n        ]).done(function(strings) {\n            var confirmMessage = strings[1].replace('{$a}', parentName);\n            Notification.confirm(strings[0], confirmMessage, strings[2], strings[3], function() {\n                Ajax.call([{\n                    methodname: 'local_parentmanager_remove_parent',\n                    args: {parentid: parentId}\n                }])[0].done(function(response) {\n                    if (response.success) {\n                        // Reload the page.\n                        window.location.reload();\n                    }\n                }).fail(Notification.exception);\n            });\n        });\n    };\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","Ajax","Notification","Modal","ModalSaveCancel","ModalEvents","Str","viewChildren","parentId","parentName","get_strings","key","component","done","strings","call","methodname","args","parentid","response","body","children","length","forEach","child","profileurl","fullname","email","relationid","create","title","show","removeOnClose","large","then","modal","getRoot","on","e","preventDefault","relationId","this","data","removeChild","fail","exception","confirm","success","window","location","reload","assignChild","require","Fragment","formPromise","loadFragment","setSaveButtonText","save","selectedIds","find","val","map","id","parseInt","childids","hide","get_string","errorMsg","addNotification","message","type","removeParent","confirmMessage","replace","init","document"],"mappings":"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"}