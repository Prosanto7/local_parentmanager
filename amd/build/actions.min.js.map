{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for Parent Manager plugin actions.\n *\n * @module     local_parentmanager/actions\n * @copyright  2026\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/modal_factory', 'core/modal_events', 'core/str'],\n    function($, Ajax, Notification, ModalFactory, ModalEvents, Str) {\n\n    /**\n     * Initialize the module.\n     */\n    var init = function() {\n        // Handle \"View Children\" action.\n        $(document).on('click', '[data-action=\"view-children\"]', function(e) {\n            e.preventDefault();\n            var parentId = $(this).data('parentid');\n            var parentName = $(this).data('parentname');\n            viewChildren(parentId, parentName);\n        });\n\n        // Handle \"Assign Child\" action.\n        $(document).on('click', '[data-action=\"assign-child\"]', function(e) {\n            e.preventDefault();\n            var parentId = $(this).data('parentid');\n            var parentName = $(this).data('parentname');\n            assignChild(parentId, parentName);\n        });\n\n        // Handle \"Remove Parent\" action.\n        $(document).on('click', '[data-action=\"remove-parent\"]', function(e) {\n            e.preventDefault();\n            var parentId = $(this).data('parentid');\n            var parentName = $(this).data('parentname');\n            removeParent(parentId, parentName);\n        });\n    };\n\n    /**\n     * View children assigned to a parent.\n     *\n     * @param {int} parentId Parent user ID\n     * @param {string} parentName Parent name\n     */\n    var viewChildren = function(parentId, parentName) {\n        Str.get_strings([\n            {key: 'assignedchildrenforparent', component: 'local_parentmanager'},\n            {key: 'nochildren', component: 'local_parentmanager'},\n            {key: 'remove', component: 'core'},\n            {key: 'close', component: 'core'}\n        ]).done(function(strings) {\n            Ajax.call([{\n                methodname: 'local_parentmanager_get_children',\n                args: {parentid: parentId}\n            }])[0].done(function(response) {\n                var body = '<div class=\"parent-children-list\">';\n\n                if (response.children.length === 0) {\n                    body += '<p>' + strings[1] + '</p>';\n                } else {\n                    body += '<table class=\"table table-striped\">';\n                    body += '<thead><tr><th>Name</th><th>Email</th><th>Actions</th></tr></thead>';\n                    body += '<tbody>';\n\n                    response.children.forEach(function(child) {\n                        body += '<tr>';\n                        body += '<td><a href=\"' + child.profileurl + '\" target=\"_blank\">' + child.fullname + '</a></td>';\n                        body += '<td>' + child.email + '</td>';\n                        body += '<td><button class=\"btn btn-sm btn-danger\" data-action=\"remove-child\" ' +\n                                'data-relationid=\"' + child.relationid + '\">' + strings[2] + '</button></td>';\n                        body += '</tr>';\n                    });\n\n                    body += '</tbody></table>';\n                }\n\n                body += '</div>';\n\n                ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: strings[0] + ': ' + parentName,\n                    body: body,\n                    large: true\n                }).done(function(modal) {\n                    modal.show();\n\n                    // Handle remove child within modal.\n                    modal.getRoot().on('click', '[data-action=\"remove-child\"]', function(e) {\n                        e.preventDefault();\n                        var relationId = $(this).data('relationid');\n                        removeChild(relationId, modal, parentId, parentName);\n                    });\n                });\n            }).fail(Notification.exception);\n        });\n    };\n\n    /**\n     * Remove a child from a parent.\n     *\n     * @param {int} relationId Relation ID\n     * @param {object} modal The modal object\n     * @param {int} parentId Parent user ID\n     * @param {string} parentName Parent name\n     */\n    var removeChild = function(relationId, modal, parentId, parentName) {\n        Str.get_strings([\n            {key: 'confirm', component: 'core'},\n            {key: 'confirmremovechild', component: 'local_parentmanager'},\n            {key: 'yes', component: 'core'},\n            {key: 'no', component: 'core'},\n            {key: 'childremoved', component: 'local_parentmanager'}\n        ]).done(function(strings) {\n            Notification.confirm(strings[0], strings[1], strings[2], strings[3], function() {\n                Ajax.call([{\n                    methodname: 'local_parentmanager_remove_child',\n                    args: {relationid: relationId}\n                }])[0].done(function(response) {\n                    if (response.success) {\n                        Notification.addNotification({\n                            message: strings[4],\n                            type: 'success'\n                        });\n                        modal.hide();\n                        // Refresh the view.\n                        viewChildren(parentId, parentName);\n                    }\n                }).fail(Notification.exception);\n            });\n        });\n    };\n\n    /**\n     * Assign children to a parent.\n     *\n     * @param {int} parentId Parent user ID\n     * @param {string} parentName Parent name\n     */\n    var assignChild = function(parentId, parentName) {\n        Str.get_strings([\n            {key: 'assignchild', component: 'local_parentmanager'},\n            {key: 'nousersavailable', component: 'local_parentmanager'},\n            {key: 'assign', component: 'local_parentmanager'},\n            {key: 'cancel', component: 'core'},\n            {key: 'noselectederror', component: 'local_parentmanager'},\n            {key: 'childrenassigned', component: 'local_parentmanager'}\n        ]).done(function(strings) {\n            Ajax.call([{\n                methodname: 'local_parentmanager_get_unassigned_users',\n                args: {}\n            }])[0].done(function(response) {\n                var body = '<div class=\"parent-assign-children\">';\n\n                if (response.users.length === 0) {\n                    body += '<p>' + strings[1] + '</p>';\n                } else {\n                    body += '<form id=\"assign-children-form\">';\n                    body += '<div class=\"form-group\">';\n                    body += '<label>Select users to assign:</label>';\n                    body += '<div class=\"user-selection\" style=\"max-height: 400px; overflow-y: auto;\">';\n\n                    response.users.forEach(function(user) {\n                        body += '<div class=\"form-check\">';\n                        body += '<input class=\"form-check-input child-checkbox\" type=\"checkbox\" ' +\n                                'value=\"' + user.id + '\" id=\"user-' + user.id + '\">';\n                        body += '<label class=\"form-check-label\" for=\"user-' + user.id + '\">';\n                        body += user.fullname + ' (' + user.email + ')';\n                        body += '</label>';\n                        body += '</div>';\n                    });\n\n                    body += '</div></div></form>';\n                }\n\n                body += '</div>';\n\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: strings[0] + ': ' + parentName,\n                    body: body,\n                    large: true\n                }).done(function(modal) {\n                    modal.setSaveButtonText(strings[2]);\n                    modal.show();\n\n                    modal.getRoot().on(ModalEvents.save, function(e) {\n                        e.preventDefault();\n\n                        var selectedIds = [];\n                        modal.getRoot().find('.child-checkbox:checked').each(function() {\n                            selectedIds.push(parseInt($(this).val()));\n                        });\n\n                        if (selectedIds.length === 0) {\n                            Notification.addNotification({\n                                message: strings[4],\n                                type: 'warning'\n                            });\n                            return;\n                        }\n\n                        Ajax.call([{\n                            methodname: 'local_parentmanager_assign_children',\n                            args: {\n                                parentid: parentId,\n                                childids: selectedIds\n                            }\n                        }])[0].done(function(response) {\n                            if (response.success) {\n                                Notification.addNotification({\n                                    message: strings[5],\n                                    type: 'success'\n                                });\n                                modal.hide();\n                                // Reload the page to update counts.\n                                window.location.reload();\n                            }\n                        }).fail(Notification.exception);\n                    });\n                });\n            }).fail(Notification.exception);\n        });\n    };\n\n    /**\n     * Remove parent status.\n     *\n     * @param {int} parentId Parent user ID\n     * @param {string} parentName Parent name\n     */\n    var removeParent = function(parentId, parentName) {\n        Str.get_strings([\n            {key: 'confirm', component: 'core'},\n            {key: 'confirmremoveparent', component: 'local_parentmanager'},\n            {key: 'yes', component: 'core'},\n            {key: 'no', component: 'core'},\n            {key: 'parentremoved', component: 'local_parentmanager'}\n        ]).done(function(strings) {\n            var confirmMessage = strings[1].replace('{$a}', parentName);\n            Notification.confirm(strings[0], confirmMessage, strings[2], strings[3], function() {\n                Ajax.call([{\n                    methodname: 'local_parentmanager_remove_parent',\n                    args: {parentid: parentId}\n                }])[0].done(function(response) {\n                    if (response.success) {\n                        Notification.addNotification({\n                            message: strings[4],\n                            type: 'success'\n                        });\n                        // Reload the page.\n                        window.location.reload();\n                    }\n                }).fail(Notification.exception);\n            });\n        });\n    };\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","Ajax","Notification","ModalFactory","ModalEvents","Str","viewChildren","parentId","parentName","get_strings","key","component","done","strings","call","methodname","args","parentid","response","body","children","length","forEach","child","profileurl","fullname","email","relationid","create","type","types","DEFAULT","title","large","modal","show","getRoot","on","e","preventDefault","relationId","this","data","removeChild","fail","exception","confirm","success","addNotification","message","hide","assignChild","users","user","id","SAVE_CANCEL","setSaveButtonText","save","selectedIds","find","each","push","parseInt","val","childids","window","location","reload","removeParent","confirmMessage","replace","init","document"],"mappings":"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"}